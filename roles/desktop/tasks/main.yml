---
- name: Installation and setup of a desktop computer with GUI
  block:
  - name: Install smart desktop packages
    ansible.builtin.apt:
      pkg:
      - openvpn
      - network-manager-openvpn
      - network-manager-openvpn-gnome
      - openvpn-systemd-resolved
      - virtualbox
      - virtualbox-guest-additions-iso
      - nextcloud-desktop
      - flameshot
      - solaar
      - copyq
      - keepassxc
      - thunderbird
      - flatpak
      - gnome-software-plugin-flatpak 
      - gnome-software      

  - name: Create a install directory
    ansible.builtin.file:
      path: /home/{{ user_ansible }}/install
      state: directory
      owner: "{{ ansible_user }}"
      mode: '0755'

  # Oracle VM VirtualBox
  - name: Install Oracle VM VirtualBox
    block:
    - name: Accept Oracle license
      ansible.builtin.debconf:
        name: virtualbox-ext-pack
        question: virtualbox-ext-pack/license
        value: "true"
        vtype: select

    - name: Install VirtualBox Extension Pack
      ansible.builtin.apt:
        pkg: virtualbox-ext-pack
    when: virtualbox == True
    
  - name: Cleaning
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/hashicorp.list
      state: absent

  - name: Cleaning
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/google-chrome.sources
      state: absent
  
  - name: Cleaning
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/megasync.list
      state: absent

  - name: Cleaning
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/vscode.sources
      state: absent

  - name: Add other software
    include_tasks:
      file: "{{ item }}"
    loop: "{{ query('fileglob', '{{ role_path }}/files/*.yaml') }}"
    no_log: true

  # Support for Cisco VPN
  - name: Install OpenConnect VPN client
    ansible.builtin.apt:
      pkg:
      - openconnect
      - network-manager-openconnect
      - network-manager-openconnect-gnome
      state: present
    when: openconnect == True

  # Kodi Home Theater Software
  - name: Install Kodi media player
    ansible.builtin.apt:
      pkg: kodi
      state: present
    when: kodi == True

  - name: Add Flathub repo
    community.general.flatpak_remote:
      name: flathub
      state: present
      method: system

  - name: Change ownership of packages
    ansible.builtin.file:
      path: /home/{{ user_ansible }}/install/
      state: directory
      recurse: yes
      owner: "{{ user_ansible }}"
      group: "{{ user_ansible }}"

  when:
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_release == "jammy" or ansible_distribution_release == "noble"
    - desktop == true
