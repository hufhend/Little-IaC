---
- name: Set LDAP/AD integration variables
  ansible.builtin.set_fact:
    ldap_id_use_start_tls: "{{ 'True' if (ldap_uri is defined and ldap_uri.startswith('ldap://')) else 'False' }}"

- name: Check if SSSD is already running
  ansible.builtin.systemd:
    name: sssd
  register: sssd_service
  changed_when: false
  check_mode: false

- name: Install and configure LDAP/AD authentication
  block:
    - name: Install required packages
      ansible.builtin.package:
        name:
          - sssd
          - sssd-tools
          - oddjob
          - oddjob-mkhomedir
        state: present

    - name: Create SSSD configuration from template
      ansible.builtin.template:
        src: sssd.conf.j2
        dest: /etc/sssd/sssd.conf
        mode: 0600
        owner: root
        group: root

    - name: Enable home directory creation
      command: authselect select sssd with-mkhomedir --force
      args:
        creates: /etc/authselect/current

    - name: Start oddjobd service
      systemd:
        name: oddjobd
        state: started
        enabled: yes

    - name: Start SSSD service
      systemd:
        name: sssd
        state: started
        enabled: yes

    - name: Show current authentication configuration
      command: authselect current
      register: auth_status
      changed_when: false

    - name: Display authentication status with details
      block:
        - name: Extract authselect profile
          ansible.builtin.set_fact:
            auth_profile: "{{ auth_status.stdout_lines[0] | regex_replace('Profile ID: ', '') }}"

        - name: Extract authselect features
          ansible.builtin.set_fact:
            auth_features: "{{ auth_status.stdout_lines[2:] | join(', ') | regex_replace('^- ', '') }}"

        - name: Display formatted status
          ansible.builtin.debug:
            msg:
              - "┌─────────────────────────────────┐"
              - "│      AUTHENTICATION STATUS      │"
              - "├─────────────────────────────────┤"
              - "│ Profile  :  {{ auth_profile }}"
              - "│ Features :  {{ auth_features }}"
              - "└─────────────────────────────────┘"

    - name: Display configuration instructions
      ansible.builtin.debug:
        msg:
          - "LDAP/AD integration configured successfully!"
          - "Domain: {{ ad_domain }}"
          - "LDAP URI: {{ ldap_uri }}"
        # - "Required manual steps:"
        # - "  1. Generate password  :  sss_obfuscate -d {{ ad_domain }}"
        # - "  2. Restart service    :  systemctl restart sssd"

  when: 
    - ad_integration | default(false)
    - ansible_facts["os_family"] == "RedHat"
    - sssd_service.status.ActiveState != "active"
