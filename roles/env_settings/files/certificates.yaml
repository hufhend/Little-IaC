---
# Certificate Management Task
# ===========================
# This task installs internal CA certificates to the system's trust store.
# REQUIRED VARIABLES:
#   - add_certs: boolean (true/false) - enables certificate installation
#   - internal_certificates: list of certificates with src and dest
#
# Example variable definition (in group_vars or host_vars):
#   add_certs: true
#   internal_certificates:
#     - src: "/path/to/certificate.pem"
#       dest: "company-ca.pem"
#

- name: Set certificate facts per OS
  set_fact:
    ca_cert_path: "{{ '/etc/pki/ca-trust/source/anchors/' if ansible_facts.os_family == 'RedHat' else '/usr/local/share/ca-certificates/' }}"
    ca_update_command: "{{ 'update-ca-trust' if ansible_facts.os_family == 'RedHat' else 'update-ca-certificates' }}"
  when: add_certs | default(false)

- name: Debug certificate installation
  debug:
    msg: "Installing additional certificates to {{ ca_cert_path }} ({{ ansible_facts.os_family }})"
  changed_when: false
  when: add_certs | default(false)

- block:
    # Create certificate directory if it doesn't exist
    - name: Ensure certificate directory exists
      file:
        path: "{{ ca_cert_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    # WARNING: This task requires 'internal_certificates' variable!
    # It must be defined in group_vars, host_vars, or inventory
    #
    # Example structure:
    # internal_certificates:
    #   - src: "{{ playbook_dir }}/certificates/root-ca.pem"
    #     dest: "company-root-ca.pem"
    #   - src: "{{ playbook_dir }}/certificates/intermediate-ca.pem"
    #     dest: "company-intermediate-ca.pem"
    #
    - name: Copy additional certificates to system
      copy:
        src: "{{ cert.src }}"
        dest: "{{ ca_cert_path }}{{ cert.dest }}"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ internal_certificates }}"
      loop_control:
        loop_var: cert
        label: "{{ cert.dest }}"
      notify: "{{ ca_update_command }}"

    - name: Reload system daemons
      meta: flush_handlers

  when: add_certs | default(false)