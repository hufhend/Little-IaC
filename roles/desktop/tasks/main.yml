---
- name: Installation and setup of a desktop computer with GUI
  block:
  - name: Ansible user doesn't log in via GUI
    ansible.builtin.lineinfile:
      path: "/var/lib/AccountsService/users/{{ ansible_user }}"
      regexp: '^SystemAccount='
      line: 'SystemAccount=true'
    ignore_errors: true

  - name: Install smart desktop packages
    ansible.builtin.apt:
      pkg:
      - openvpn
      - network-manager-openvpn
      - network-manager-openvpn-gnome
      - openvpn-systemd-resolved
      - virtualbox
      - virtualbox-guest-additions-iso
      - nextcloud-desktop
      - flameshot
      - solaar
      - copyq
      - keepassxc
      - thunderbird
      - flatpak

  - name: Accept Oracle license
    ansible.builtin.debconf:
      name: virtualbox-ext-pack
      question: virtualbox-ext-pack/license
      value: "true"
      vtype: select

  - name: Install VirtualBox Extension Pack
    ansible.builtin.apt:
      pkg:
      - virtualbox-ext-pack

  # Chrome browser
  - name: Install Google Chrome
    block:
    - name: Download Google Chrome package
      ansible.builtin.get_url:
        url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        dest: /tmp/google-chrome-stable_current_amd64.deb

    - name: Install Google Chrome
      ansible.builtin.apt:
        deb: /tmp/google-chrome-stable_current_amd64.deb
        state: present

    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/google-chrome-stable_current_amd64.deb
        state: absent
    when: chrome == True

  # OnlyOffice desktop
  - name: Install OnlyOffice
    block:
    - name: Download OnlyOffice package
      ansible.builtin.get_url:
        url: https://download.onlyoffice.com/install/desktop/editors/linux/onlyoffice-desktopeditors_amd64.deb
        dest: /tmp/onlyoffice-desktopeditors_amd64.deb

    - name: Install OnlyOffice
      ansible.builtin.apt:
        deb: /tmp/onlyoffice-desktopeditors_amd64.deb
        state: present

    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/onlyoffice-desktopeditors_amd64.deb
        state: absent

    when: onlyoffice == True

  # Brave browser
  - name: Install Brave browser
    block:
    - name: Add Brave GPG apt key
      ansible.builtin.apt_key:
        url: https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
        keyring: /usr/share/keyrings/brave-browser-archive-keyring.gpg
        state: present

    - name: Add Brave repository
      ansible.builtin.apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main
        state: present
        filename: brave-browser-release.list

    - name: Install Brave browser
      ansible.builtin.apt:
        name: brave-browser
        state: present
    when: brave == True

    # MEGA Desktop App
  - name: Install megasync
    block:
    - name: Download Megasync package
      ansible.builtin.get_url:
        url: https://mega.nz/linux/repo/xUbuntu_{{ ansible_distribution_version }}/amd64/megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        dest: /tmp/megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
    - name: Install Megasync
      ansible.builtin.apt:
        deb: /tmp/megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        state: present

    - name: Download Mega manager package
      ansible.builtin.get_url: 
        url: https://mega.nz/linux/repo/xUbuntu_{{ ansible_distribution_version }}/amd64/nautilus-megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        dest: /tmp/nautilus-megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
    - name: Install Mega for nautilus
      ansible.builtin.apt:
        deb: /tmp/nautilus-megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        state: present

    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        state: absent
    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/nautilus-megasync-xUbuntu_{{ ansible_distribution_version }}_amd64.deb
        state: absent
              
    when: mega == True

  # Steam game platform
  - name: Install Steam
    block:
    - name: Download Steam package
      ansible.builtin.get_url:
        url: https://cdn.akamai.steamstatic.com/client/installer/steam.deb
        dest: /tmp/steam.deb

    - name: Install Steam
      ansible.builtin.apt:
        deb: /tmp/steam.deb
        state: present

    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/steam.deb
        state: absent

    when: steam == True

  # Visual Studio Code
  - name: Install VS Code
    block:
    - name: Download VS Code package
      ansible.builtin.get_url:
        url: https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64
        dest: /tmp/vscode.deb

    - name: Install VS Code
      ansible.builtin.apt:
        deb: /tmp/vscode.deb
        state: present

    - name: Remove package file
      ansible.builtin.file:
        path: /tmp/vscode.deb
        state: absent

    when: vscode == True

  when:
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_release == "jammy" or ansible_distribution_release == "noble"
    - desktop == true
