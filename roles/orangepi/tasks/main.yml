---
- name: Prepare OrangePi for operation
  block:
  - name: Check if swap file exists
    ansible.builtin.stat:
      path: "{{ swap_path }}/{{ swap_file }}"
    register: swap_file_check

  - name: Install swap file
    block:
      - name: Create swap file
        ansible.builtin.command: touch "{{ swap_path }}/{{ swap_file }}"

      - name: Allocate swap file
        ansible.builtin.command: fallocate -l {{ swap_size }} "{{ swap_path }}/{{ swap_file }}"

      # - name: Create swap space
      #   command: dd if=/dev/zero of=/swapfile bs=1024 count=3670016

      - name: Set permissions on swap file
        ansible.builtin.file:
          path: "{{ swap_path }}/{{ swap_file }}"
          mode: 0600

      - name: Format swap file
        ansible.builtin.command: mkswap "{{ swap_path }}/{{ swap_file }}"

      - name: Add swap to fstab
        ansible.builtin.lineinfile:
          dest: /etc/fstab
          regexp: "{{ swap_path }}/{{ swap_file }}"
          line: "{{ swap_path }}/{{ swap_file }} none swap sw 0 0"

      - name: Turn on swap
        ansible.builtin.command: swapon -a

      - name: Set swapiness
        ansible.posix.sysctl:
          name: vm.swappiness
          value: "1"
        
    when: not swap_file_check.stat.exists

  - name: Shorten history for sysstat
    ansible.builtin.lineinfile:
      path: /etc/sysstat/sysstat
      regexp: '^HISTORY=7'
      line: 'HISTORY=3'

  - name: Keep history for sysstat
    ansible.builtin.lineinfile:
      path: /etc/sysstat/sysstat
      regexp: '^COMPRESSAFTER=10'
      line: 'COMPRESSAFTER=1'

  - name: Install Git packages
    ansible.builtin.apt:
      pkg:
        - git

  when: orange == true