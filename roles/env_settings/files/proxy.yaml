- name: Universal proxy configuration for all systems
  block:
    - name: Configure system-wide proxy in /etc/environment
      ansible.builtin.template:
        src: environment.j2
        dest: /etc/environment
        mode: '0644'
      when: proxy_config | default(false)

    - name: Configure dirmngr proxy for GPG
      block:
        - name: Ensure GPG directory exists
          ansible.builtin.file:
            path: /root/.gnupg
            state: directory
            mode: '0700'

        - name: Configure dirmngr proxy
          ansible.builtin.template:
            src: dirmngr.conf.j2
            dest: /root/.gnupg/dirmngr.conf
            mode: '0644'

    - name: Configure APT proxy for Debian family
      ansible.builtin.template:
        src: 95proxy.j2
        dest: /etc/apt/apt.conf.d/95proxy
        mode: '0644'
      when: ansible_facts["os_family"] == "Debian"

    - name: Configure DNF/YUM proxy for RedHat family
      ansible.builtin.template:
        src: dnf-proxy.conf.j2
        dest: "{{ '/etc/dnf/dnf.conf' if ansible_facts['distribution_major_version'] | int >= 8 else '/etc/yum.conf' }}"
        mode: '0644'
      when: ansible_facts["os_family"] == "RedHat"

  when: proxy_config | default(false)
