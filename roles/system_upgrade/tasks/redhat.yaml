---
- name: Clean DNF cache and lock files
  ansible.builtin.command:
    cmd: dnf clean all

- name: Remove YUM/DNF cache metadata
  ansible.builtin.file:
    path: /var/cache/dnf
    state: absent
  
- name: Remove DNF lock files
  ansible.builtin.file:
    path: /var/run/dnf.pid
    state: absent
  
- name: Stop dnf-makecache timer
  ansible.builtin.systemd:
    name: dnf-makecache.timer
    state: stopped
  
- name: Stop dnf-makecache service
  ansible.builtin.systemd:
    name: dnf-makecache.service
    state: stopped
  
- name: Check repositories
  ansible.builtin.command: dnf makecache
  
- name: Update repositories
  ansible.builtin.dnf:
    name: "*"
    state: latest

- name: Start dnf-makecache service
  ansible.builtin.systemd:
    name: dnf-makecache.service
    state: started

- name: Start dnf-makecache timer
  ansible.builtin.systemd:
    name: dnf-makecache.timer
    state: started

# - name: Add Prometheus repository
#   ansible.builtin.yum_repository:
#     name: prometheus
#     description: Prometheus repo
#     baseurl: https://packagecloud.io/prometheus-rpm/release/el/$releasever/$basearch
#     gpgcheck: yes
#     enabled: yes
#     gpgkey: 
#       - https://packagecloud.io/prometheus-rpm/release/gpgkey
#       - https://raw.githubusercontent.com/lest/prometheus-rpm/master/RPM-GPG-KEY-prometheus-rpm


- name: Enable EPEL repository for RedHat
  block:
    - name: Enable subscription-manager
      ansible.builtin.command:
        cmd: subscription-manager config --rhsm.manage_repos=1

    - name: Get architecture
      ansible.builtin.command: uname -m
      register: architecture

    - name: Enable CodeReady Builder repository
      rhsm_repository:
        name: codeready-builder-for-rhel-{{ ansible_distribution_major_version }}-{{ architecture.stdout }}-rpms
        state: enabled

    - name: Import EPEL GPG key
      ansible.builtin.rpm_key:
        state: present
        key: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}
        
    - name: Install EPEL to RedHat
      ansible.builtin.dnf:
        name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm
        state: latest

    - name: Refresh the repo cache
      ansible.builtin.dnf:
        update_cache: yes

    - name: Verify EPEL repo is enabled
      ansible.builtin.command:
        cmd: yum repolist enabled | grep epel
      register: epel_repo_check
      changed_when: false

    - name: Debug EPEL repo check result
      ansible.builtin.debug:
        var: epel_repo_check.stdout
  when:
    - ansible_distribution == "RedHat"
    - ansible_distribution_major_version in ["9", "10"]


- name: Install EPEL packages for CentOS 9 and Rocky 9
  block:
    - name: Install EPEL packages to CentOS and Rocky
      ansible.builtin.dnf:
        name:
          - epel-release
          # - epel-next-release
        state: latest

    - name: Install subscription-manager
      ansible.builtin.dnf:
        name:
          - subscription-manager
        state: latest
  when: 
    - ansible_distribution == "CentOS" or ansible_distribution == "Rocky"
    - ansible_distribution_major_version == "9"


- name: Install useful packages
  ansible.builtin.dnf:
    name:
      - ca-certificates
      - curl
      - htop
      - screen
      - mc
      - sysstat
      - fail2ban
      - nfs-utils
      - ethtool
      - ufw
      - langpacks-en
      - langpacks-cs
      - glibc-all-langpacks
      - bash-completion
      # - node_exporter
    state: latest
  
- name: Start the fail2ban service
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true

- name: Start the sysstat service
  ansible.builtin.systemd:
    name: sysstat
    state: started
    enabled: true
