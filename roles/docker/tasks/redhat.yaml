---
- name: Install Docker - containers for applications
  block:
  - name: Uninstall any conflicting packages
    ansible.builtin.dnf:
      pkg:
        - docker
        - docker-client
        - docker-client-latest
        - docker-common
        - docker-latest
        - docker-latest-logrotate
        - docker-logrotate
        - docker-engine
        - podman
        - runc
      state: absent
      update_cache: true

  - name: Install dnf-plugins-core package
    ansible.builtin.dnf:
      name: dnf-plugins-core
      state: present

  - name: Add Docker CE repository
    ansible.builtin.yum_repository:
      name: docker-ce
      description: Docker CE Stable
      baseurl: https://download.docker.com/linux/rhel/{{ ansible_facts['distribution_major_version'] }}/x86_64/stable
      gpgcheck: yes
      gpgkey: https://download.docker.com/linux/rhel/gpg
      enabled: yes
      state: present

  - name: Install Docker
    ansible.builtin.dnf:
      pkg:
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-compose-plugin
        - docker-buildx-plugin
      state: latest
      update_cache: true

  - name: Enable Docker service
    ansible.builtin.systemd:
      name: docker
      enabled: yes
      state: started

  - name: Check if user is in docker group
    ansible.builtin.command: id -nG {{ ansible_user }}
    register: user_groups
    changed_when: false

  - name: Add current user to docker group
    ansible.builtin.user:
      name: "{{ docker_user }}"
      groups: docker
      append: yes

  # Restart only on first pass
  - name: Reboot the system
    ansible.builtin.reboot:
      msg: "Reboot initiated by Ansible for Docker installation"
      reboot_timeout: 600
    when: "'docker' not in user_groups.stdout.split()"

  # Show installed version
  - name: Get Docker version
    command: docker version
    register: docker_version_result

  - name: Get Docker Compose version
    command: docker compose version
    register: docker_compose_version_result

  - name: Extract Docker versions
    set_fact:
      docker_client_version: "{{ docker_version_result.stdout | regex_search('Client:.*\\n Version:\\s+([\\d.]+)', '\\1') | default(['unknown']) | first }}"
      docker_engine_version: "{{ docker_version_result.stdout | regex_search('Engine:\\s*\\n\\s+Version:\\s+([\\d.]+)', '\\1') | default(['unknown'], true) | first }}"
      containerd_version: "{{ docker_version_result.stdout | regex_search('containerd:\\s*\\n\\s+Version:\\s+([\\w.]+)', '\\1') | default(['unknown'], true) | first }}"
      runc_version: "{{ docker_version_result.stdout | regex_search('runc:\\s*\\n\\s+Version:\\s+([\\d.]+)', '\\1') | default(['unknown'], true) | first }}"
      docker_init_version: "{{ docker_version_result.stdout | regex_search('docker-init:\\s*\\n\\s+Version:\\s+([\\d.]+)', '\\1') | default(['unknown'], true) | first }}"
      docker_compose_version: "{{ docker_compose_version_result.stdout | regex_search('Docker Compose version v([\\d.]+)', '\\1') | default(['unknown'], true) | first }}"

  - name: Show Docker versions
    ansible.builtin.debug:
      msg:
      - "Docker client: {{ docker_client_version }}"
      - "Docker engine: {{ docker_engine_version }}, containerd: {{ containerd_version }}, runc: {{ runc_version }}, docker-init: {{ docker_init_version }}, compose: {{ docker_compose_version }}"

  when:
    - role not in ['combi', 'master', 'worker']
    - ansible_facts["os_family"] | lower == "redhat"
    - ansible_facts['distribution_major_version']== "9" 
